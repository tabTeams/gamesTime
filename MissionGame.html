<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>เกมภารกิจลับสมอง: ช่วยตัวประกัน</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #f0f0f0;
    text-align: center;
    padding: 20px;
    line-height: 1.6;
}
button {
    display: block;
    margin: 10px auto;
    padding: 12px 24px;
    font-size: 18px;
    cursor: pointer;
    width: 80%;
    max-width: 400px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
}
button:hover:not(:disabled) {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
}
button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
    background-color: #6c757d;
}
#gameArea, #introScreen {
    background-color: #1e1e1e;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
    max-width: 900px;
    margin: 20px auto;
}
.hidden {
    display: none;
}
#introText {
    font-size: 1.1em;
    line-height: 1.8;
    background-color: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
    border-left: 5px solid #007bff;
    text-align: left;
}
#volumeControl {
    margin-top: 25px;
    padding: 15px;
    background-color: #2a2a2a;
    border-radius: 8px;
}
#volumeControl label {
    font-size: 1.1em;
    color: #bbb;
    margin-right: 15px;
}
#volumeSlider {
    width: 250px;
    -webkit-appearance: none;
    height: 8px;
    background: #555;
    outline: none;
    border-radius: 4px;
}
#volumeSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: #007bff;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid #fff;
}
#levelHeader, #timer, #status {
    font-size: 1.5em;
    font-weight: bold;
    color: #4CAF50;
    margin-bottom: 20px;
}
#timer {
    color: #FFC107;
}
#status {
    color: #dc3545;
}
#challengeBox {
    background-color: #333;
    padding: 25px;
    border-radius: 10px;
    border: 1px solid #444;
}
#challengeDescription {
    font-size: 1.3em;
    margin-bottom: 20px;
}
#inputField {
    padding: 10px;
    font-size: 20px;
    text-align: center;
    width: 80%;
    max-width: 300px;
    margin-bottom: 15px;
    border-radius: 5px;
    border: 1px solid #555;
    background-color: #444;
    color: #fff;
}
.choice-btn {
    padding: 12px;
    font-size: 1.1em;
    margin: 8px;
    background-color: #444;
    border: 1px solid #666;
    color: white;
}
.choice-btn:hover:not(:disabled) {
    background-color: #555;
}
#resultMessage {
    font-size: 1.2em;
    margin-top: 20px;
    padding: 10px;
    border-radius: 5px;
}
.correct-result {
    color: #28a745;
    background-color: rgba(40, 167, 69, 0.2);
}
.incorrect-result {
    color: #dc3545;
    background-color: rgba(220, 53, 69, 0.2);
}
#nextLevelBtn, #restartBtn {
    margin-top: 25px;
}
</style>
</head>
<body>

<h1>เกมภารกิจลับสมอง</h1>

<div id="volumeControl">
    <label for="volumeSlider">ปรับระดับเสียงดนตรี:</label>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.1">
</div>

<div id="introScreen">
    <div id="introText">
        <p>คุณคือเจ้าหน้าที่ทหารหน่วยพิเศษ ภารกิจของคุณคือการช่วยเหลือตัวประกันที่ถูกจับไปขังไว้ในบ้านร้างขนาดใหญ่แห่งหนึ่ง ตัวประกันกำลังตกอยู่ในอันตรายและเวลาใกล้จะหมดลงแล้ว!</p>
        <p>ในการช่วยเหลือครั้งนี้ คุณจะต้องใช้ไหวพริบและสติปัญญาเพื่อไขปริศนาต่างๆ ในแต่ละด่าน เพื่อปลดล็อกประตู, หาทางเข้า, และค้นหาที่ซ่อนของตัวประกัน</p>
        <p>เกมนี้มีทั้งหมด 20 ด่าน แต่ละด่านจะเพิ่มความท้าทายขึ้นเรื่อยๆ คุณพร้อมสำหรับภารกิจกู้ชีพแล้วหรือยัง?</p>
    </div>
    <button id="startBtn">เริ่มภารกิจ</button>
    <a href="index.html" style="text-decoration: none;"><button id="homeBtn1">กลับสู่หน้าหลัก</button></a>
</div>

<div id="gameArea" class="hidden">
    <div id="levelHeader"></div>
    <div id="timer"></div>
    <div id="status"></div>
    <div id="challengeBox">
        <div id="challengeDescription"></div>
        <div id="choices"></div>
    </div>
    <div id="resultMessage"></div>
    <button id="restartBtn" class="hidden">เริ่มภารกิจใหม่</button>
    <a href="index.html" style="text-decoration: none;"><button id="homeBtn2" class="hidden">กลับสู่หน้าหลัก</button></a>
</div>

<audio id="bgMusic1" src="Mission1.ogg" loop></audio>
<audio id="successSound" src="correct.ogg"></audio>
<audio id="failSound" src="wrong.ogg"></audio>
<audio id="missionCompleteSound" src="victory.ogg"></audio>
<audio id="gameOverSound" src="failure.ogg"></audio>
<audio id="keyUnlockSound" src="key_unlock.ogg"></audio>
<audio id="buttonPressSound" src="button_press.ogg"></audio>
<audio id="doorOpenSound" src="door_open.ogg"></audio>
<audio id="runningStairsSound" src="running_stairs.ogg"></audio>

<script>
const introScreen = document.getElementById('introScreen');
const gameArea = document.getElementById('gameArea');
const startBtn = document.getElementById('startBtn');
const homeBtn1 = document.getElementById('homeBtn1');
const homeBtn2 = document.getElementById('homeBtn2');
const levelHeader = document.getElementById('levelHeader');
const timerDisplay = document.getElementById('timer');
const statusDisplay = document.getElementById('status');
const challengeDescription = document.getElementById('challengeDescription');
const choicesDiv = document.getElementById('choices');
const resultMessage = document.getElementById('resultMessage');
const restartBtn = document.getElementById('restartBtn');
const volumeSlider = document.getElementById('volumeSlider');
const bgMusic1 = document.getElementById('bgMusic1');
const successSound = document.getElementById('successSound');
const failSound = document.getElementById('failSound');
const missionCompleteSound = document.getElementById('missionCompleteSound');
const gameOverSound = document.getElementById('gameOverSound');
const keyUnlockSound = document.getElementById('keyUnlockSound');
const buttonPressSound = document.getElementById('button_press.ogg');
const doorOpenSound = document.getElementById('door_open.ogg');
const runningStairsSound = document.getElementById('running_stairs.ogg');

let currentLevel = 0;
let timer;
let timeLeft;
const maxLevels = 20;
let extraTime = 0; // เพิ่มตัวแปรสำหรับเวลาที่เหลือ
const maxIncorrectAttempts = 3;
let incorrectAttemptsInLevel = 0;

let missionData = [];

// กำหนดค่าความดังเริ่มต้นสำหรับเสียงดนตรีประกอบและเสียงเอฟเฟกต์
if(bgMusic1) bgMusic1.volume = 0.1;
if(successSound) successSound.volume = 1.0;
if(failSound) failSound.volume = 1.0;
if(missionCompleteSound) missionCompleteSound.volume = 1.0;
if(gameOverSound) gameOverSound.volume = 1.0;
if(keyUnlockSound) keyUnlockSound.volume = 1.0;
if(buttonPressSound) buttonPressSound.volume = 1.0;
if(doorOpenSound) doorOpenSound.volume = 1.0;
if(runningStairsSound) runningStairsSound.volume = 1.0;

// ควบคุมระดับเสียงดนตรีประกอบเท่านั้น
if(volumeSlider) {
    volumeSlider.addEventListener('input', (e) => {
        const volume = e.target.value;
        if(bgMusic1) bgMusic1.volume = volume;
    });
}

// เริ่มเกมและปลดล็อกเสียงเมื่อผู้ใช้กดปุ่ม
if(startBtn) {
    startBtn.addEventListener('click', () => {
        // ย้ายการเปลี่ยนหน้าจอมาไว้ที่นี่เพื่อรับประกันว่า UI จะอัปเดต
        introScreen.classList.add('hidden');
        gameArea.classList.remove('hidden');

        try {
            // ทดลองเล่นเสียงเพื่อปลดล็อกในเบราว์เซอร์
            if (bgMusic1) bgMusic1.play();
        } catch (e) {
            console.error("Error playing audio on button click:", e);
        }
        
        missionData = generateAllMissions();
        currentLevel = 0;
        extraTime = 0; // รีเซ็ตเวลาสะสมเมื่อเริ่มเกมใหม่
        startLevel();
    });
}

if(restartBtn) restartBtn.addEventListener('click', () => location.reload());

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function startTimer(duration) {
    clearInterval(timer);
    timeLeft = duration;
    if(timerDisplay) timerDisplay.textContent = `เวลาที่เหลือ: ${timeLeft} วินาที`;
    timer = setInterval(() => {
        timeLeft--;
        if(timerDisplay) timerDisplay.textContent = `เวลาที่เหลือ: ${timeLeft} วินาที`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            endGame(false, "หมดเวลา! ภารกิจล้มเหลว");
        }
    }, 1000);
}

function startLevel() {
    currentLevel++;
    if (currentLevel > maxLevels) {
        endGame(true, `ยินดีด้วย! คุณตอบคำถามครบ ${maxLevels} ด่านและช่วยตัวประกันสำเร็จ! 🏆`);
        return;
    }
    
    // จัดการเพลงประกอบและเสียงวิ่งขึ้นบันได
    if (bgMusic1) {
        bgMusic1.pause();
        bgMusic1.currentTime = 0;
        bgMusic1.play();
    }
    if (currentLevel > 1) {
        if (runningStairsSound) runningStairsSound.play();
    }

    // รีเซ็ตจำนวนครั้งที่ตอบผิดและอัปเดตสถานะ
    incorrectAttemptsInLevel = 0;
    updateStatus();

    if(levelHeader) levelHeader.textContent = `ภารกิจที่ ${currentLevel}`;
    if(resultMessage) resultMessage.textContent = '';
    if(restartBtn) restartBtn.classList.add('hidden');
    if(homeBtn2) homeBtn2.classList.add('hidden');
    if(choicesDiv) choicesDiv.innerHTML = '';

    const mission = missionData[currentLevel - 1];
    if(challengeDescription) challengeDescription.textContent = mission.description;

    // สร้างปุ่มตัวเลือก
    if(choicesDiv) {
        choicesDiv.classList.remove('hidden');
        const shuffledChoices = shuffleArray(mission.choices);
        shuffledChoices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.textContent = choice;
            btn.onclick = () => {
                if(buttonPressSound) buttonPressSound.play();
                checkAnswer(btn.textContent);
            };
            choicesDiv.appendChild(btn);
        });
    }
    
    // เพิ่มเวลาสะสมจากด่านที่แล้ว
    const totalTimeForThisLevel = mission.timeLimit + extraTime;
    extraTime = 0; // รีเซ็ตเวลาสะสมหลังจากนำมาใช้
    startTimer(totalTimeForThisLevel);
}

function updateStatus() {
    if (statusDisplay) {
        statusDisplay.textContent = `จำนวนครั้งที่ตอบผิด: ${incorrectAttemptsInLevel}/${maxIncorrectAttempts}`;
    }
}

function generateAllMissions() {
    const missions = [];
    const timeLimitAllLevels = 60;
    
    const riddles = [
        ["อะไรเอ่ย ยิ่งหักยิ่งยาว ยิ่งเติมยิ่งสั้น?", "อายุ"],
        ["อะไรเอ่ย มีแต่หัวไม่มีหาง มีแต่เลขไม่มีคำพูด?", "นาฬิกา"],
        ["อะไรเอ่ย ยิ่งให้ยิ่งมี ยิ่งเก็บยิ่งไม่มี?", "ความรู้"],
        ["อะไรเอ่ย ยิ่งเดินยิ่งห่างยิ่งเดินยิ่งใกล้?", "เงา"],
        ["อะไรเอ่ย มีตาแต่มองไม่เห็น?", "สับปะรด"],
        ["อะไรเอ่ย ยิ่งร้อนยิ่งแข็ง?", "ไอศกรีม"],
        ["อะไรเอ่ย ยิ่งตัดยิ่งคม?", "กรรไกร"]
    ];
    const primes = [41, 43, 47, 53, 59, 61, 67, 71];
    const colors = ['แดง','เขียว','น้ำเงิน','ม่วง','ส้ม','เหลือง'];
    const colorRiddles = {
        'แดง': 'สีที่แสดงถึงความรัก',
        'เขียว': 'สีของธนบัตร 20 บาท',
        'น้ำเงิน': 'สีของน้ำทะเล',
        'ม่วง': 'สีของดอกอัญชัน',
        'ส้ม': 'สีของผลส้ม',
        'เหลือง': 'สีของดอกทานตะวัน'
    };

    // Helper function to create distractors for choices
    function getDistractors(correctAnswer, allPossibleAnswers, count = 4) {
        const distractors = allPossibleAnswers.filter(a => a !== correctAnswer);
        return shuffleArray(distractors).slice(0, count);
    }
    
    // Levels 1-12
    // Level 1: Random sum
    const numbers1 = shuffleArray([2, 3, 4, 5, 8, 9, 10, 11]).slice(0, 5);
    const sum1 = numbers1.reduce((a, b) => a + b, 0);
    const sumChoices = getDistractors(String(sum1), [String(sum1), String(sum1+1), String(sum1-1), String(sum1+10), String(sum1-10)]);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 1: "ประตูบ้านถูกล็อกด้วยระบบดิจิทัล รหัสปลดล็อกคือผลรวมของ ${numbers1.join(', ')} จงเลือกคำตอบเพื่อเข้าบ้าน"`,
        answer: String(sum1),
        choices: [String(sum1), ...sumChoices],
        timeLimit: timeLimitAllLevels
    });
    
    // Level 2: Random floor choice
    const floorRiddles = [
        { riddle: `"ตัวประกันส่งสัญญาณมาว่า "เขาถูกขังไว้ในห้องบนชั้นที่ต้องเดินลงไป" คุณต้องเลือกคำตอบที่ถูกต้องตามความจริง`, answer: 'ชั้นใต้ดิน' },
        { riddle: `"ตัวประกันส่งสัญญาณมาว่า "เขาถูกขังไว้ในห้องที่อยู่ตรงกลางระหว่างชั้น 1 และชั้น 5" คุณต้องเลือกคำตอบที่ถูกต้องตามความจริง`, answer: 'ชั้นที่ 3' },
        { riddle: `"ตัวประกันส่งสัญญาณมาว่า "เขาถูกขังไว้ในห้องที่อยู่บนชั้นสุดท้ายก่อนถึงดาดฟ้า" คุณต้องเลือกคำตอบที่ถูกต้องตามความจริง`, answer: 'ชั้นที่ 4' },
        { riddle: `"ตัวประกันส่งสัญญาณมาว่า "เขาถูกขังไว้ในห้องบนชั้นที่ต้องใช้รหัสผ่านเท่านั้น" ชั้นของบ้านหลังนี้ไม่มีรหัสผ่าน มีตั้งแต่ชั้นใต้ดิน, ชั้น 1, 2, 3, 4, และชั้นบนสุดเป็นดาดฟ้า" คุณต้องเลือกคำตอบที่ถูกต้องตามความจริง`, answer: 'ชั้นดาดฟ้า' }
    ];
    
    const randomFloorRiddle = floorRiddles[Math.floor(Math.random() * floorRiddles.length)];
    missions.push({
        type: 'choices',
        description: randomFloorRiddle.riddle,
        answer: randomFloorRiddle.answer,
        choices: ['ชั้นใต้ดิน', 'ชั้นที่ 1', 'ชั้นที่ 2', 'ชั้นที่ 3', 'ชั้นที่ 4', 'ชั้นดาดฟ้า'].slice(0, 5),
        timeLimit: timeLimitAllLevels
    });

    // Level 3: Prime numbers
    const randomPrime = primes[Math.floor(Math.random() * primes.length)];
    const nextPrime = primes[primes.indexOf(randomPrime) + 1];
    const primeChoices = getDistractors(String(nextPrime), [String(nextPrime), String(randomPrime+1), String(randomPrime+2), String(nextPrime+1), String(nextPrime-1)]);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 3: "รหัสปลดล็อกลิฟต์คือจำนวนเฉพาะตัวถัดไปจาก ${randomPrime}"`,
        answer: String(nextPrime),
        choices: [String(nextPrime), ...primeChoices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 4: Riddle
    const randomRiddle1 = riddles[Math.floor(Math.random() * riddles.length)];
    const riddle1Choices = getDistractors(randomRiddle1[1], riddles.map(r => r[1]));
    missions.push({
        type: 'choices',
        description: `ด่านที่ 4: "รหัสผ่านห้องเก็บอุปกรณ์คือคำตอบของคำปริศนา" ${randomRiddle1[0]}`,
        answer: randomRiddle1[1],
        choices: [randomRiddle1[1], ...riddle1Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 5: Number clue
    const floorIndex = Math.floor(Math.random() * 5) + 1;
    const floorsInHouse = ['ห้องชั้นที่ 1', 'ห้องชั้นที่ 2', 'ห้องชั้นที่ 3', 'ห้องชั้นที่ 4', 'ห้องชั้นที่ 5'];
    missions.push({
        type: 'choices',
        description: `ด่านที่ 5: "กล้องวงจรปิดถูกตัดสัญญาณทั้งหมด ข้อมูลสุดท้ายที่ได้มาคือภาพสัญลักษณ์รูปวงกลมที่มีเลข ${floorIndex} กำกับอยู่ คุณจะต้องเดาห้องที่ใกล้เคียงกับข้อมูลที่ได้มา"`,
        answer: `ห้องชั้นที่ ${floorIndex}`,
        choices: floorsInHouse.slice(0,5),
        timeLimit: timeLimitAllLevels
    });

    // Level 6: Math equation 1
    const numA1 = Math.floor(Math.random() * 10) + 5;
    const numB1 = Math.floor(Math.random() * 10) + 5;
    const result1 = numA1 * numB1;
    const math1Choices = getDistractors(String(result1), [String(result1), String(result1+1), String(result1-1), String(result1+10), String(result1-10)]);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 6: "เครื่องกำเนิดไฟฟ้าถูกล็อกด้วยรหัสที่ได้จากผลคูณของโจทย์ทางคณิตศาสตร์ ${numA1} * ${numB1} = ?"`,
        answer: String(result1),
        choices: [String(result1), ...math1Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 7: Riddle 2
    const randomRiddle2 = riddles[Math.floor(Math.random() * riddles.length)];
    const riddle2Choices = getDistractors(randomRiddle2[1], riddles.map(r => r[1]));
    missions.push({
        type: 'choices',
        description: `ด่านที่ 7: "รหัสลับห้องเก็บของคือคำตอบของคำปริศนา" ${randomRiddle2[0]}`,
        answer: randomRiddle2[1],
        choices: [randomRiddle2[1], ...riddle2Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 8: Alphabet code
    const alphabet = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'];
    const randomCode = shuffleArray(alphabet).slice(0, 4).join('').toUpperCase();
    const codeChoices = getDistractors(randomCode, [randomCode, 'ABCD', 'WXYZ', 'JUMP', 'CODE']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 8: "คุณพบกับเครื่องถอดรหัสลับ รหัสคือคำที่ถอดรหัสออกมาได้คือ ${randomCode}"`,
        answer: randomCode,
        choices: [randomCode, ...codeChoices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 9: Riddle 3
    const randomRiddle3 = riddles[Math.floor(Math.random() * riddles.length)];
    const riddle3Choices = getDistractors(randomRiddle3[1], riddles.map(r => r[1]));
    missions.push({
        type: 'choices',
        description: `ด่านที่ 9: "คุณพบกับเครื่องถอดรหัสลับ รหัสคือคำตอบของคำปริศนา" ${randomRiddle3[0]}`,
        answer: randomRiddle3[1],
        choices: [randomRiddle3[1], ...riddle3Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 10: Color clue
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    missions.push({
        type: 'choices',
        description: `ด่านที่ 10: "คุณพบกับรหัสลับที่ใช้สีเป็นตัวใบ้ คำใบ้คือ '${colorRiddles[randomColor]}'"`,
        answer: randomColor,
        choices: colors.slice(0,5),
        timeLimit: timeLimitAllLevels
    });
    
    // Level 11: Math equation 2
    const numC1 = Math.floor(Math.random() * 20) + 1;
    const numD1 = Math.floor(Math.random() * 20) + 1;
    const result2 = numC1 + numD1;
    const math2Choices = getDistractors(String(result2), [String(result2), String(result2+1), String(result2-1), String(result2+5), String(result2-5)]);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 11: "รหัสลับสุดท้ายคือผลรวมของโจทย์ทางคณิตศาสตร์ ${numC1} + ${numD1} = ?"`,
        answer: String(result2),
        choices: [String(result2), ...math2Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });
    
    // Level 12: Final math equation
    const numA2 = Math.floor(Math.random() * 10) + 1;
    const numB2 = Math.floor(Math.random() * 10) + 1;
    const numC2 = Math.floor(Math.random() * 10) + 1;
    const result3 = numA2 * numB2 + numC2;
    const math3Choices = getDistractors(String(result3), [String(result3), String(result3+1), String(result3-1), String(result3+5), String(result3-5)]);
    missions.push({
        type: 'choices',
        description: `ด่านสุดท้าย: "คุณพบตัวประกันแล้ว แต่ประตูห้องถูกล็อกด้วยรหัสที่คำนวณได้จากโจทย์คณิตศาสตร์ (${numA2} * ${numB2}) + ${numC2} = ?"`,
        answer: String(result3),
        choices: [String(result3), ...math3Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // --- NEW ESCAPE LEVELS (13-20) - NUMBER PUZZLES ---
    // Level 13: Simple addition
    const result13 = 12;
    const puzzle13Choices = getDistractors(String(result13), [String(result13), '10', '11', '13', '14']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 13: "คุณและตัวประกันกำลังจะหนีออกจากบ้านร้าง รหัสประตูแรกคือผลรวมของ 'จำนวนนิ้วมือในมือข้างเดียว' กับ 'จำนวนวันในหนึ่งสัปดาห์' "`,
        answer: String(result13),
        choices: [String(result13), ...puzzle13Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 14: Simple division
    const result14 = 6;
    const puzzle14Choices = getDistractors(String(result14), [String(result14), '4', '5', '7', '8']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 14: "คุณและตัวประกันมาถึงทางแยกที่มีรหัสผ่าน รหัสคือ 'จำนวนชั่วโมงในหนึ่งวัน' หารด้วย 'จำนวนล้อบนรถยนต์' "`,
        answer: String(result14),
        choices: [String(result14), ...puzzle14Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });
    
    // Level 15: Simple multiplication
    const result15 = 9;
    const puzzle15Choices = getDistractors(String(result15), [String(result15), '8', '10', '12', '15']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 15: "คุณและตัวประกันต้องปิดสัญญาณเตือนภัย รหัสคือ 'จำนวนด้านของสามเหลี่ยม' คูณกับ 'จำนวนสีในธงชาติไทย' "`,
        answer: String(result15),
        choices: [String(result15), ...puzzle15Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });
    
    // Level 16: Simple subtraction
    const result16 = 1;
    const puzzle16Choices = getDistractors(String(result16), [String(result16), '0', '2', '3', '4']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 16: "คุณพบโน้ตที่เขียนรหัสผ่านสำหรับประตู รหัสคือ 'จำนวนเดือนในหนึ่งปี' ลบด้วย 'จำนวนผู้เล่นในทีมฟุตบอล' "`,
        answer: String(result16),
        choices: [String(result16), ...puzzle16Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 17: Addition puzzle
    const result17 = 10;
    const puzzle17Choices = getDistractors(String(result17), [String(result17), '9', '11', '12', '13']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 17: "คุณเจอแผงวงจรที่มีรหัสผ่านซ่อนอยู่ รหัสคือผลรวมของ 'จำนวนวันในหนึ่งสัปดาห์' กับ 'จำนวนล้อบนรถสามล้อ' "`,
        answer: String(result17),
        choices: [String(result17), ...puzzle17Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });
    
    // Level 18: Multiplication puzzle
    const result18 = 10;
    const puzzle18Choices = getDistractors(String(result18), [String(result18), '8', '12', '15', '20']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 18: "คุณพบรหัสสำหรับเปิดกล่องเครื่องมือ รหัสคือ 'จำนวนนิ้วเท้าบนเท้าข้างเดียว' คูณกับ 'จำนวนหูของคนหนึ่งคน' "`,
        answer: String(result18),
        choices: [String(result18), ...puzzle18Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 19: Addition puzzle 2
    const result19 = 20;
    const puzzle19Choices = getDistractors(String(result19), [String(result19), '18', '19', '21', '22']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 19: "คุณมาถึงรถหลบหนี แต่ต้องใส่รหัส รหัสคือ 'จำนวนเดือนในหนึ่งปี' บวกกับ 'จำนวนดาวเคราะห์ในระบบสุริยะ' "`,
        answer: String(result19),
        choices: [String(result19), ...puzzle19Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });

    // Level 20: Final multiplication puzzle
    const result20 = 21;
    const puzzle20Choices = getDistractors(String(result20), [String(result20), '18', '20', '24', '28']);
    missions.push({
        type: 'choices',
        description: `ด่านที่ 20: "คุณสตาร์ทรถสำเร็จแล้ว เหลือแค่เปิดประตูรั้ว รหัสคือ 'จำนวนวันในหนึ่งสัปดาห์' คูณกับ 'จำนวนสีในไฟจราจร' "`,
        answer: String(result20),
        choices: [String(result20), ...puzzle20Choices.slice(0, 4)],
        timeLimit: timeLimitAllLevels
    });
    
    return missions;
}

function checkAnswer(userAnswer) {
    const mission = missionData[currentLevel - 1];
    let isCorrect = userAnswer.toLowerCase().trim() === mission.answer.toLowerCase().trim();
    
    const choiceButtons = document.querySelectorAll('#choices .choice-btn');
    choiceButtons.forEach(btn => btn.disabled = true);

    if (isCorrect) {
        clearInterval(timer);
        extraTime = timeLeft;
        if(resultMessage) {
            resultMessage.textContent = `ยอดเยี่ยม! ภารกิจสำเร็จ! คุณมีเวลาเพิ่ม ${extraTime} วินาทีสำหรับด่านต่อไป!`;
            resultMessage.className = 'correct-result';
        }
        if(keyUnlockSound) keyUnlockSound.play();
        setTimeout(() => {
            if(doorOpenSound) doorOpenSound.play();
            setTimeout(startLevel, 1500);
        }, 800);
    } else {
        incorrectAttemptsInLevel++;
        updateStatus();
        if(resultMessage) {
            resultMessage.textContent = 'คำตอบผิดพลาด! ลองใหม่อีกครั้ง';
            resultMessage.className = 'incorrect-result';
        }
        if(failSound) failSound.play();
        
        if (incorrectAttemptsInLevel >= maxIncorrectAttempts) {
            setTimeout(() => endGame(false, `คุณตอบผิดครบ ${maxIncorrectAttempts} ครั้ง! ภารกิจล้มเหลว`), 1000);
        } else {
            choiceButtons.forEach(btn => btn.disabled = false); // เปิดให้เลือกใหม่
        }
    }
}

function endGame(isWin, message) {
    if(bgMusic1) bgMusic1.pause();

    clearInterval(timer);
    if(levelHeader) levelHeader.textContent = '';
    if(timerDisplay) timerDisplay.textContent = '';
    if (statusDisplay) statusDisplay.textContent = '';
    if(challengeDescription) challengeDescription.textContent = message;
    if(choicesDiv) choicesDiv.innerHTML = '';
    if(resultMessage) resultMessage.textContent = '';
    
    if (isWin) {
        if(missionCompleteSound) missionCompleteSound.play();
    } else {
        if(gameOverSound) gameOverSound.play();
    }
    
    if(restartBtn) restartBtn.classList.remove('hidden');
    if(homeBtn2) homeBtn2.classList.remove('hidden');
}
</script>

</body>
</html>