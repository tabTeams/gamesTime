<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>เกมตอบคำถามเศรษฐศาสตร์</title>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f8ff;
    color: #000;
    text-align: center;
    padding: 20px;
}
button {
    display: block;
    margin: 10px auto;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    width: 80%;
    max-width: 500px;
    border: 2px solid #0056b3;
    border-radius: 5px;
    background-color: #f9f9f9;
    color: #000;
    transition: background-color 0.3s, transform 0.2s;
}
button:hover:not(:disabled) {
    background-color: #e0e0e0;
    transform: scale(1.02);
}
button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}
#gameArea, #introScreen {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    max-width: 800px;
    margin: 20px auto;
}
.hidden {
    display: none;
}
#questionBox {
    font-size: 24px;
    margin-bottom: 20px;
    font-weight: bold;
}
#choices button {
    margin: 15px auto;
}
#explanation {
    font-size: 18px;
    margin-top: 15px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background-color: #fdfdfd;
}
#status {
    font-size: 20px;
    font-weight: bold;
    color: #0056b3;
    margin-bottom: 15px;
}
#nextBtn, #restartBtn, #homeBtn {
    margin-top: 20px;
    background-color: #007bff;
    color: white;
    font-size: 20px;
    width: 60%;
    max-width: 300px;
}
#restartBtn {
    background-color: #28a745;
}
#shareBtn {
    background-color: #17a2b8;
    color: white;
}
/* Style for correct/incorrect answers */
.correct {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
}
.incorrect {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
}
#homeBtn.end-game-btn {
    background-color: #6c757d;
}
</style>
</head>
<body>

<h1>เกมตอบคำถามเศรษฐศาสตร์</h1>

<div id="introScreen">
    <h2>ยินดีต้อนรับสู่เกมตอบคำถามเศรษฐศาสตร์</h2>
    <p>เกมนี้จะทดสอบความรู้ด้านเศรษฐศาสตร์ของคุณ มาดูกติกากัน!</p>
    <ul>
        <li><b>เริ่มจากเลเวล 1:</b> เกมนี้มีทั้งหมด 10 เลเวล แต่ละเลเวลประกอบด้วยคำถาม 10 ข้อ</li>
        <li><b>เงื่อนไขการผ่าน:</b> คุณจะต้องตอบถูกตั้งแต่ **7 ข้อขึ้นไป** จึงจะสามารถผ่านไปเล่นในเลเวลถัดไปได้</li>
        <li><b>โอกาสในการตอบผิด:</b> คุณสามารถตอบผิดได้ไม่เกิน **3 ครั้ง** ในแต่ละเลเวล หากตอบผิดเกิน 3 ครั้ง เกมจะโอเวอร์ทันที</li>
        <li><b>สรุปผล:</b> เมื่อเกมสิ้นสุด จะมีการสรุปคะแนนรวมทั้งหมดที่คุณทำได้ตลอดทั้งเกม</li>
        <li><b>ระบบอำนวยความสะดวก:</b> ระบบจะสลับตำแหน่งคำตอบในแต่ละข้อ และจะเลื่อนไปคำถามถัดไปโดยอัตโนมัติเมื่อคุณตอบเสร็จ</li>
    </ul>
    <button id="startBtn">เริ่มเล่นเกม</button>
    <button id="homeBtn" onclick="window.location.href='index.html'">กลับสู่หน้าหลัก</button>
</div>

<div id="levelInfo" class="hidden">
    <div><strong>เลเวลปัจจุบัน =  <span id="levelLabel">1</span></strong></div>
    <div id="chapterName" class="small"> </div>
    <div class="small"> ( /เลเวล)</div>
</div>

<div id="gameArea" class="hidden">
    <div id="status"></div>
    <div id="questionBox" role="alert" aria-live="assertive"></div>
    <div id="choices">
        <button class="choice" data-index="0"></button>
        <button class="choice" data-index="1"></button>
        <button class="choice" data-index="2"></button>
        <button class="choice" data-index="3"></button>
    </div>
    <div id="explanation" aria-live="polite"></div>
    <button id="nextBtn" class="hidden">ถัดไป</button>
    <button id="shareBtn" class="hidden">แชร์คะแนน</button>
    <button id="restartBtn" class="hidden">เล่นใหม่</button>
    <button id="homeBtnEnd" class="hidden end-game-btn" onclick="window.location.href='index.html'">กลับสู่หน้าหลัก</button>
</div>

<audio id="correctSound" src="correct.ogg"></audio>
<audio id="wrongSound" src="wrong.ogg"></audio>
<audio id="levelUpSound" src="level-up.ogg"></audio>
<audio id="victorySound" src="victory.ogg"></audio>
<audio id="failureSound" src="failure.ogg"></audio>

<script>
// =======  =======
const questionsPerLevel = 10;
const maxIncorrectAnswers = 3;
const minCorrectToPass = 7;
const maxLevels = 10;

// ======= แมปเลเวล = บท =======
const chapterTitles = {
  1: "บทที่ 1 หลักพื้นฐานทางเศรษฐศาสตร์",
  2: "บทที่ 2 อุปสงค์ อุปทาน และดุลยภาพตลาด",
  3: "บทที่ 3 ต้นทุนการผลิตและรายได้",
  4: "บทที่ 4 โครงสร้างตลาดและการแข่งขัน",
  5: "บทที่ 5 ดุลยภาพผู้บริโภค/ผู้ผลิต",
  6: "บทที่ 6 ภาพรวมเศรษฐกิจ (มหภาค)",
  7: "บทที่ 7 รายได้ประชาชาติ ว่างงาน เงินเฟ้อ",
  8: "บทที่ 8 นโยบายการคลัง",
  9: "บทที่ 9 เงิน ระบบการเงิน และนโยบายการเงิน",
 10: "บทที่ 10 เศรษฐกิจระหว่างประเทศ"
};

// ======= คลังคำศัพท์-นิยามต่อบท (15 คู่ => 30 ข้อ/บท) =======
const chapterTermDefs = {
  1: [
    ["ทรัพยากรมีจำกัด","ข้อจำกัดที่ทำให้ต้องเลือกและจัดสรร"],
    ["ต้นทุนค่าเสียโอกาส","มูลค่าของทางเลือกที่ดีที่สุดที่สละไป"],
    ["ปัญหาพื้นฐานเศรษฐกิจ","ผลิตอะไร ผลิตอย่างไร ผลิตเพื่อใคร"],
    ["หน่วยครัวเรือน","ผู้บริโภคที่มุ่งความพึงพอใจสูงสุด"],
    ["หน่วยผลิต","ผู้ผลิตที่มุ่งกำไรสูงสุด"],
    ["จุลภาค","ศึกษาหน่วยเศรษฐกิจย่อยและราคา"],
    ["มหภาค","ศึกษาภาพรวมเศรษฐกิจทั้งระบบ"],
    ["สินค้าเสรี","มีมากเพียงพอ ไม่ต้องแลกเปลี่ยน"],
    ["สินค้าเศรษฐกิจ","มีจำกัด ต้องแลกเปลี่ยน"],
    ["สินค้าแทนกัน","ทดแทนกันได้ เช่น ชา-กาแฟ"],
    ["สินค้าร่วมกัน","ต้องใช้ร่วม เช่น ปากกากับไส้ปากกา"],
    ["แรงงาน","ปัจจัยที่ให้ผลตอบแทนเป็นค่าจ้าง"],
    ["ที่ดิน","ปัจจัยที่ให้ผลตอบแทนเป็นค่าเช่า"],
    ["ทุน","ปัจจัยที่ให้ผลตอบแทนเป็นดอกเบี้ย"],
    ["ผู้ประกอบการ","ให้ผลตอบแทนเป็นกำไร"]
  ],
  2: [
    ["อุปสงค์","ปริมาณที่ผู้บริโภคต้องการซื้อ ณ ราคาต่าง ๆ"],
    ["อุปทาน","ปริมาณที่ผู้ผลิตต้องการขาย ณ ราคาต่าง ๆ"],
    ["กฎอุปสงค์","ราคาเพิ่ม ปริมาณซื้อย่อมลดลง"],
    ["กฎอุปทาน","ราคาเพิ่ม ปริมาณขายย่อมเพิ่มขึ้น"],
    ["ดุลยภาพตลาด","ปริมาณซื้อ=ขาย ที่ราคาหนึ่ง"],
    ["ส่วนเกินผู้บริโภค","ส่วนต่างระหว่างความเต็มใจจ่ายกับราคาจริง"],
    ["ส่วนเกินผู้ผลิต","ส่วนต่างระหว่างราคาจริงกับต้นทุนยอมรับ"],
    ["อุปสงค์ส่วนเกิน","ราคาต่ำกว่าดุลยภาพ ปริมาณซื้อเกิน"],
    ["อุปทานส่วนเกิน","ราคาสูงกว่าดุลยภาพ ปริมาณขายเกิน"],
    ["ปัจจัยกำหนดอุปสงค์","ราคา รายได้ รสนิยม ประชากร ฯลฯ"],
    ["ปัจจัยกำหนดอุปทาน","ราคา ต้นทุน เทคโนโลยี ผู้ขาย ฯลฯ"],
    ["สินค้าแทนกัน","ราคาสินค้า A เพิ่ม อุปสงค์ B เพิ่ม"],
    ["สินค้าร่วมกัน","ราคาสินค้า A เพิ่ม อุปสงค์ B ลด"],
    ["ยืดหยุ่นของอุปสงค์","การตอบสนองปริมาณซื้อเมื่อราคาปรับ"],
    ["ยืดหยุ่นของอุปทาน","การตอบสนองปริมาณขายเมื่อราคาปรับ"]
  ],
  3: [
    ["TFC","ต้นทุนคงที่รวม ไม่เปลี่ยนตามปริมาณผลิต"],
    ["TVC","ต้นทุนแปรผันรวม เปลี่ยนตามปริมาณผลิต"],
    ["TC","ต้นทุนรวม = TFC + TVC"],
    ["MC","ต้นทุนส่วนเพิ่ม จากการผลิตเพิ่ม 1 หน่วย"],
    ["ATC","ต้นทุนเฉลี่ยรวม = TC/Q"],
    ["AVC","ต้นทุนเฉลี่ยแปรผัน = TVC/Q"],
    ["AFC","ต้นทุนเฉลี่ยคงที่ = TFC/Q"],
    ["ผลได้ส่วนเพิ่มลดลง","เพิ่มปัจจัยแปรผันมากขึ้น ผลผลิตส่วนเพิ่มลด"],
    ["ผลิตภาพ","ผลผลิตต่อหน่วย投入"],
    ["จุดต่ำสุด AVC","จุดที่ MC ตัด AVC ที่ต่ำสุด"],
    ["ต้นทุนโอกาส","ต้นทุนจากทางเลือกที่สละไปในการผลิต"],
    ["TR","รายรับรวม = ราคา × ปริมาณขาย"],
    ["กำไร","TR - TC"],
    ["Economies of Scale","ต้นทุนเฉลี่ยลดลงเมื่อขยายการผลิต"],
    ["Diseconomies","ต้นทุนเฉลี่ยสูงขึ้นเมื่อใหญ่เกินไป"]
  ],
  4: [
    ["แข่งขันสมบูรณ์","ผู้ซื้อผู้ขายมาก สินค้าเหมือน เข้าตลาดเสรี"],
    ["ผูกขาดกึ่งแข่งขัน","ผู้ขายหลายราย สินค้าแตกต่าง"],
    ["ผู้ขายน้อยราย","ผู้ขายไม่กี่ราย มีอิทธิพลต่อราคา"],
    ["ผูกขาด","ผู้ขายรายเดียว ไม่มีสิ่งทดแทนใกล้เคียง"],
    ["อำนาจตลาด","กำหนดราคาเหนือ MC ได้"],
    ["กีดกันราคา","แบ่งราคาแตกต่างตามกลุ่มลูกค้า"],
    ["อุปสรรคเข้าสู่ตลาด","สิทธิบัตร ขนาดประหยัด เงินลงทุนสูง"],
    ["แข่งขันไม่ใช่ราคา","โฆษณา บริการ แบรนด์"],
    ["คาร์เทล","ร่วมมือกำหนดราคา/ปริมาณ"],
    ["HHI","ดัชนีความกระจุกตัวของตลาด"],
    ["ผลสวัสดิการ","ผลต่อส่วนเกินรวม"],
    ["Markup","ส่วนต่างระหว่างราคาและ MC"],
    ["ภาษีนำเข้า","กำแพงภาษีที่กีดกัน"],
    ["โควตา/ใบอนุญาต","จำกัดปริมาณหรือการเข้าสู่ตลาด"],
    ["ราคากำกับ","รัฐกำหนดเพดานหรือพื้นราคา"]
  ],
  5: [
    ["MU ส่วนเพิ่ม","ความพึงพอใจเพิ่มจากการบริโภคเพิ่ม 1 หน่วย"],
    ["ดุลยภาพผู้บริโภค","MUx/Px = MUy/Py ใต้งบประมาณ"],
    ["เส้นงบประมาณ","ชุดทางเลือกที่ทำได้ด้วยรายได้หนึ่ง"],
    ["เส้นไร้ความแตกต่าง","ชุดสินค้าที่ให้ความพึงพอใจเท่ากัน"],
    ["ดุลยภาพผู้ผลิต","กำไรสูงสุดเมื่อ MR=MC"],
    ["ส่วนเกินผู้บริโภค","พื้นที่ใต้ D เหนือราคา"],
    ["ส่วนเกินผู้ผลิต","พื้นที่เหนือ S ใต้ราคา"],
    ["ภาษีทางอ้อม","ผลักภาระไปผู้บริโภคได้บางส่วน"],
    ["เงินอุดหนุน","รัฐช่วยจ่าย ลดต้นทุน"],
    ["ผลเสียภายนอก","ต้นทุนที่ไม่สะท้อนในราคา"],
    ["ผลดีภายนอก","ประโยชน์ที่ไม่สะท้อนในราคา"],
    ["ล้มเหลวของตลาด","ตลาดจัดสรรทรัพยากรไม่เหมาะสม"],
    ["สินค้าเอกชน","กีดกันได้และแย่งใช้ได้"],
    ["สินค้าสาธารณะ","ไม่กีดกันและไม่แย่งใช้"],
    ["สรุปจุลภาค","ดุลยภาพและสวัสดิการรวม"]
  ],
  6: [
    ["มหภาคคือ","ศึกษาผลผลิตรวม ราคา การจ้างงาน"],
    ["เป้าหมายมหภาค","เติบโต เสถียรภาพราคา จ้างงาน ดุลชำระเงิน"],
    ["GDP","มูลค่าผลผลิตสุดท้ายที่ผลิตในประเทศ"],
    ["GNP","มูลค่าผลผลิตโดยคนชาติไม่ว่าที่ใด"],
    ["นามธรรม/ที่แท้จริง","GDP นามธรรม vs ที่แท้จริง"],
    ["วัฏจักรธุรกิจ","ช่วงขยายตัว-ถดถอย"],
    ["จุดสูงสุด","ปลายช่วงขยายก่อนชะลอ"],
    ["จุดต่ำสุด","ปลายช่วงถดถอยก่อนฟื้น"],
    ["AD","อุปสงค์รวมต่อผลผลิตและระดับราคา"],
    ["AS","อุปทานรวมของผู้ผลิต"],
    ["นโยบายมหภาค","การคลังและการเงิน"],
    ["ค่าใช้จ่ายรวม","C+I+G+(X-M)"],
    ["เงินเฟ้อทั่วไป","ระดับราคาเพิ่มขึ้นโดยทั่วไป"],
    ["ดัชนีราคา","CPI, GDP deflator"],
    ["TFP","ผลิตภาพรวมปัจจัย"]
  ],
  7: [
    ["รายได้ประชาชาติ","รายได้รวมของประชากรประเทศ"],
    ["ว่างงานโครงสร้าง","ทักษะไม่ตรงงาน"],
    ["ว่างงานเสียดสี","ช่วงเปลี่ยนงาน/หางาน"],
    ["ว่างงานวัฏจักร","เกิดจากเศรษฐกิจถดถอย"],
    ["อัตราว่างงานธรรมชาติ","ระดับที่ไม่กดดันเงินเฟ้อ"],
    ["เงินเฟ้ออุปสงค์ดึง","AD เพิ่มกดดันราคา"],
    ["เงินเฟ้อต้นทุนดัน","ต้นทุนเพิ่มดันราคา"],
    ["เงินฝืด","ระดับราคาลดลงทั่วไป"],
    ["ฟิลลิปส์เคิร์ฟ","ความสัมพันธ์เงินเฟ้อ-ว่างงานระยะสั้น"],
    ["GDP (รายจ่าย)","C+I+G+X-M"],
    ["GDP (รายได้)","ค่าจ้าง+ดอกเบี้ย+ค่าเช่า+กำไร+ภาษีทางอ้อม-อุดหนุน"],
    ["CPI","ดัชนีราคาผู้บริโภค"],
    ["อัตราเติบโต","การเปลี่ยนแปลงร้อยละของผลผลิตจริง"],
    ["ตัวคูณรายได้","รายได้เพิ่มมากกว่าการใช้จ่ายเริ่มแรก"],
    ["ช่องว่างเงินเฟ้อ/เงินฝืด","ส่วนต่างผลผลิตจริงกับศักยภาพ"]
  ],
  8: [
    ["นโยบายการคลัง","การใช้รายจ่ายและภาษีของรัฐ"],
    ["งบขาดดุล","รายจ่าย>รายรับ"],
    ["งบเกินดุล","รายรับ>รายจ่าย"],
    ["ตัวคูณการคลัง","ผลของ G/Tax ต่อรายได้รวม"],
    ["ตัวปรับเสถียรอัตโนมัติ","ภาษีก้าวหน้า/เงินโอนตอบสนองวัฏจักร"],
    ["เพดานราคา","ราคาสูงสุดตามกฎหมาย (ต่ำกว่าดุลยภาพ)"],
    ["ราคาพื้น","ราคาต่ำสุดตามกฎหมาย (สูงกว่าดุลยภาพ)"],
    ["การจัดซื้อของรัฐ","ส่วนของ G ใน GDP"],
    ["โครงสร้างรายจ่ายรัฐ","บริหาร เศรษฐกิจ สังคม ฯลฯ"],
    ["หนี้สาธารณะ","หนี้ที่รัฐกู้"],
    ["Crowding Out","G สูงดันดอกเบี้ย กด I เอกชน"],
    ["ภาษีทางตรง","เช่น ภาษีเงินได้บุคคลธรรมดา"],
    ["ภาษีทางอ้อม","เช่น ภาษีมูลค่าเพิ่ม"],
    ["สมดุลเชิงวัฏจักร","ปรับนโยบายตามช่วงเศรษฐกิจ"],
    ["กฎวินัยการคลัง","กรอบจำกัดขาดดุล/หนี้"]
  ],
  9: [
    ["เงิน","สื่อกลาง หน่วยวัด เก็บมูลค่า"],
    ["M1","เงินสด+เงินฝากกระแสรายวัน"],
    ["M2","M1+เงินฝากออมทรัพย์/ประจำ"],
    ["ธนาคารกลาง","กำหนดนโยบายการเงิน"],
    ["อัตราเงินสดสำรอง","สัดส่วนเงินฝากที่ต้องสำรอง"],
    ["ตลาดเงิน","ตราสารหนี้อายุสั้น สภาพคล่องสูง"],
    ["ตลาดทุน","ตราสารอายุยาว หุ้น/พันธบัตร"],
    ["การเงินตึงตัว","ลดปริมาณเงิน/ขึ้นดอกเบี้ย"],
    ["การเงินผ่อนคลาย","เพิ่มปริมาณเงิน/ลดดอกเบี้ย"],
    ["ดอกเบี้ยนโยบาย","ชี้นำต้นทุนการกู้"],
    ["ส่วนลด/รีไฟแนนซ์","ปล่อยกู้แก่ธนาคารพาณิชย์"],
    ["ตัวคูณเงินฝาก","การขยายตัวสินเชื่อทวีคูณ"],
    ["งบดุลธนาคาร","สินทรัพย์=หนี้สิน+ทุน"],
    ["เสถียรภาพการเงิน","ระบบดูดซับช็อกได้"],
    ["อัตราแลกเปลี่ยน","ราคาของเงินหนึ่งต่ออีกสกุล"]
  ],
 10: [
    ["การค้าเสรี","กีดกันต่ำ แลกเปลี่ยนเสรี"],
    ["ได้เปรียบเชิงเปรียบเทียบ","ผลิตสินค้าที่เสียโอกาสต่ำกว่า"],
    ["อัตราแลกเปลี่ยนลอยตัว","ปล่อยให้ตลาดกำหนดค่าเงิน"],
    ["อัตราแลกเปลี่ยนคงที่","ธนาคารกลางตรึงค่าเงิน"],
    ["ดุลการชำระเงิน","บัญชีเดินสะพัด/ทุนและการเงิน"],
    ["ภาษีนำเข้า","ภาษีสำหรับสินค้านำเข้า"],
    ["โควตานำเข้า","กำหนดปริมาณนำเข้าขั้นสูงสุด"],
    ["FTA","ความตกลงการค้าเสรี"],
    ["การไหลเวียนทุน","การย้ายเงินทุนระหว่างประเทศ"],
    ["บัญชีเดินสะพัด","สินค้า บริการ รายได้ โอนฝ่ายเดียว"],
    ["บัญชีทุน/การเงิน","ลงทุนโดยตรง/พอร์ต เงินสำรอง"],
    ["กีดกันทางการค้า","มาตรการภาษี/ไม่ใช่ภาษี"],
    ["Impossible Trinity","การเงินอิสระ/อัตราแลกเปลี่ยน/ทุนเสรี เลือกได้สอง"],
    ["อัตราแลกเปลี่ยนที่แท้จริง","อัตราแลกเปลี่ยนปรับด้วยระดับราคา"],
    ["เงื่อนไขการค้า","อัตราส่วนราคาส่งออกต่อราคานำเข้า"]
  ]
};

// ======= สร้างคำถาม 30 ข้อต่อบท (2 รูปแบบ/คู่คำ) =======
function shuffleArray(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function makeQuestionsFromPairs(pairs){
  const out = [];
  // แบบที่ 1: ถามนิยามของคำ
  pairs.forEach(([term,def])=>{
    const distractors = shuffleArray(pairs.filter(p=>p[1]!==def)).slice(0,3).map(p=>p[1]);
    const choices = shuffleArray([def,...distractors]);
    out.push({q:`ข้อใดคือความหมายของ “${term}”?`,choices,answer:choices.indexOf(def),explanation:`“${term}” หมายถึง ${def}`});
  });
  // แบบที่ 2: ให้นิยามแล้วถามคำ
  pairs.forEach(([term,def])=>{
    const distractors = shuffleArray(pairs.filter(p=>p[0]!==term)).slice(0,3).map(p=>p[0]);
    const choices = shuffleArray([term,...distractors]);
    out.push({q:`นิยามต่อไปนี้หมายถึงคำว่าอะไร: “${def}”`,choices,answer:choices.indexOf(term),explanation:`นิยามนี้ตรงกับ “${term}”`});
  });
  return out;
}

// เตรียมคลังคำถามสำหรับทั้ง 10 บท รวม 300 ข้อ เก็บไว้ในหน่วยความจำ
const chapterQuestionBanks = {};
for(let lvl=1; lvl<=maxLevels; lvl++){
  chapterQuestionBanks[lvl] = makeQuestionsFromPairs(chapterTermDefs[lvl]);
}

// ======= อ้างอิงองค์ประกอบ DOM =======
const introScreen = document.getElementById("introScreen");
const levelInfo = document.getElementById("levelInfo");
const levelLabel = document.getElementById("levelLabel");
const chapterName = document.getElementById("chapterName");
const gameArea = document.getElementById("gameArea");
const statusDiv = document.getElementById("status");
const questionBox = document.getElementById("questionBox");
const choicesBtns = document.querySelectorAll(".choice");
const explanationDiv = document.getElementById("explanation");
const nextBtn = document.getElementById("nextBtn");
const shareBtn = document.getElementById("shareBtn");
const restartBtn = document.getElementById("restartBtn");
const homeBtnEnd = document.getElementById("homeBtnEnd");

// เสียง (คง id และ src เดิม)
const correctSound = document.getElementById("correctSound");
const wrongSound = document.getElementById("wrongSound");
const levelUpSound = document.getElementById("levelUpSound");
const victorySound = document.getElementById("victorySound");
const failureSound = document.getElementById("failureSound");
[correctSound,wrongSound,levelUpSound,victorySound,failureSound].forEach(a=>a.load());

// ======= สถานะเกม =======
let currentLevel = 1;
let availableQuestions = [];
let currentQuestion = null;
let questionsAnsweredInLevel = 0;
let correctAnswersInLevel = 0;
let incorrectAnswersInLevel = 0;
let consecutiveCorrect = 0;
// เพิ่มตัวแปรสำหรับคะแนนรวม
let totalCorrectAnswers = 0;
let totalQuestionsAnswered = 0;

// ปุ่มเริ่ม/ตัวเลือก/แชร์/รีสตาร์ท/ถัดไป
document.getElementById("startBtn").addEventListener("click", initializeGame);
choicesBtns.forEach((btn,idx)=>btn.addEventListener("click",()=>checkAnswer(idx)));
shareBtn.addEventListener("click", shareScore);
restartBtn.addEventListener("click", ()=>location.reload());
document.addEventListener("keydown",(e)=>{
  if(["1","2","3","4"].includes(e.key)){
    const i = parseInt(e.key,10)-1;
    if(i>=0 && i<4 && !Array.from(choicesBtns).every(b=>b.disabled)){ checkAnswer(i); }
  }
});

// ======= ฟังก์ชันเกม (คงกติกาเดิม) =======
function initializeGame(){
  introScreen.classList.add("hidden");
  gameArea.classList.remove("hidden");
  levelInfo.classList.remove("hidden");
  currentLevel = 1;
  totalCorrectAnswers = 0; // รีเซ็ตคะแนนรวมเมื่อเริ่มเกมใหม่
  totalQuestionsAnswered = 0; // รีเซ็ตคำถามที่ตอบไปทั้งหมดเมื่อเริ่มเกมใหม่
  startLevel();
}
function startLevel(){
  levelLabel.textContent = currentLevel;
  chapterName.textContent = "";
  questionsAnsweredInLevel = 0;
  correctAnswersInLevel = 0;
  incorrectAnswersInLevel = 0;
  consecutiveCorrect = 0;
  // สุ่ม 10 ข้อจากคลังบทนี้ (คลังเต็ม 30 ข้อ)
  const bank = shuffleArray(chapterQuestionBanks[currentLevel]);
  availableQuestions = bank.slice(0, questionsPerLevel);
  // แสดงปุ่มตัวเลือก
  choicesBtns.forEach(b=>{ b.classList.remove("hidden"); b.disabled=false; b.classList.remove("correct","incorrect"); });
  homeBtnEnd.classList.add("hidden");
  loadQuestion();
  updateStatus();
}
function updateStatus(){
  statusDiv.textContent = `ตอบถูก: ${correctAnswersInLevel}/${questionsPerLevel} | ตอบผิด: ${incorrectAnswersInLevel}/${maxIncorrectAnswers}`;
}
function loadQuestion(){
  if(questionsAnsweredInLevel>=questionsPerLevel){ summarizeLevel(); return; }
  currentQuestion = availableQuestions[questionsAnsweredInLevel];
  const shuffled = shuffleArray(currentQuestion.choices);
  const answerText = currentQuestion.choices[currentQuestion.answer];
  const newAnswerIndex = shuffled.indexOf(answerText);
  currentQuestion._shuffled = shuffled;
  currentQuestion._newAnswer = newAnswerIndex;

  questionBox.textContent = currentQuestion.q;
  choicesBtns.forEach((btn,i)=>{
    btn.textContent = shuffled[i];
    btn.classList.remove("correct","incorrect");
    btn.disabled = false;
  });
  explanationDiv.textContent = "";
  nextBtn.classList.add("hidden");
  shareBtn.classList.add("hidden");
  restartBtn.classList.add("hidden");
  homeBtnEnd.classList.add("hidden");
}
function checkAnswer(selectedIndex){
  choicesBtns.forEach(b=>b.disabled=true);
  questionsAnsweredInLevel++;
  totalQuestionsAnswered++;
  const isCorrect = (selectedIndex===currentQuestion._newAnswer);
  if(isCorrect){
    correctAnswersInLevel++;
    totalCorrectAnswers++; // เพิ่มคะแนนรวม
    consecutiveCorrect++;
    choicesBtns[selectedIndex].classList.add("correct");
    explanationDiv.textContent = `${consecutiveCorrect===1?"ถูกต้อง!":"เยี่ยมมาก!"} ${currentQuestion.explanation||""}`;
    try{correctSound.play();}catch(_){}
  }else{
    incorrectAnswersInLevel++;
    consecutiveCorrect = 0;
    choicesBtns[selectedIndex].classList.add("incorrect");
    choicesBtns[currentQuestion._newAnswer].classList.add("correct");
    const answerText = currentQuestion._shuffled[currentQuestion._newAnswer];
    explanationDiv.textContent = `ยังไม่ถูก คำตอบที่ถูกคือ: ${answerText}. ${currentQuestion.explanation||""}`;
    try{wrongSound.play();}catch(_){}
  }
  updateStatus();
  if(incorrectAnswersInLevel > maxIncorrectAnswers){
    setTimeout(()=>endGame(false),800);
  }else if(questionsAnsweredInLevel===questionsPerLevel){
    setTimeout(()=>summarizeLevel(),1500); // เพิ่มเวลาเพื่อให้ผู้เล่นได้อ่านเฉลย
  }else{
    // เปลี่ยนจากแสดงปุ่ม "ถัดไป" เป็นการโหลดข้อถัดไปอัตโนมัติ
    setTimeout(()=>loadQuestion(),1500); // เพิ่มเวลาเพื่อให้ผู้เล่นได้อ่านเฉลย
  }
}
function summarizeLevel(){
  choicesBtns.forEach(b=>b.disabled=true);
  let summaryText="";
  // เปลี่ยนเงื่อนไขการผ่านเลเวล
  if(correctAnswersInLevel >= minCorrectToPass && incorrectAnswersInLevel <= maxIncorrectAnswers){
    questionBox.textContent = `ผ่านเลเวล ${currentLevel}! 🎉`;
    summaryText = `คุณตอบถูก ${correctAnswersInLevel} ข้อ จาก ${questionsPerLevel} ข้อในเลเวลนี้!`;
    try{levelUpSound.play();}catch(_){}
    if(currentLevel<maxLevels){
      setTimeout(()=>nextLevel(),1200);
    }else{
      setTimeout(()=>endGame(true),1200);
    }
  }else{
    questionBox.textContent = `ไม่ผ่าน! เกมโอเวอร์`;
    summaryText = `ในเลเวลนี้ คุณตอบถูก ${correctAnswersInLevel} ข้อ และตอบผิด ${incorrectAnswersInLevel} ข้อ`;
    try{failureSound.play();}catch(_){}
    setTimeout(()=>endGame(false),1200);
  }
  explanationDiv.textContent = summaryText;
  shareBtn.classList.remove("hidden");
  restartBtn.classList.remove("hidden");
  nextBtn.classList.add("hidden");
}
function nextLevel(){
  currentLevel++;
  questionBox.textContent = `เตรียมตัวสำหรับเลเวล ${currentLevel}.`;
  explanationDiv.textContent = "";
  setTimeout(()=>startLevel(),800);
}
function endGame(isWin){
  choicesBtns.forEach(b=>b.classList.add("hidden"));
  nextBtn.classList.add("hidden");
  restartBtn.classList.remove("hidden");
  shareBtn.classList.remove("hidden");
  homeBtnEnd.classList.remove("hidden");
  
  let finalMessage="";
  if(isWin){
    finalMessage = `ยินดีด้วย! คุณตอบคำถามครบทุกเลเวลและชนะเกมแล้ว! 🏆`;
    try{victorySound.play();}catch(_){}
  }else{
    finalMessage = `เกมโอเวอร์! คุณไปถึงเลเวล ${currentLevel} 😥`;
    try{failureSound.play();}catch(_){}
  }
  
  // เพิ่มการสรุปคะแนนรวม
  questionBox.textContent = finalMessage;
  explanationDiv.textContent = `คุณตอบถูกทั้งหมด ${totalCorrectAnswers} ข้อ จากคำถามทั้งหมด ${totalQuestionsAnswered} ข้อ`;
}
function shareScore(){
  const shareText = `ฉันเล่นเกมตอบคำถามเศรษฐศาสตร์ และไปได้ถึงเลเวล ${currentLevel} ทำคะแนนได้ ${totalCorrectAnswers} จาก ${totalQuestionsAnswered} ข้อ!`;
  const shareData = {title:'เกมตอบคำถามเศรษฐศาสตร์', text:shareText, url:window.location.href};
  if(navigator.share){ navigator.share(shareData).catch(()=>{}); } else { alert(shareText); }
}
</script>

</body>
</html>